# Лекция 14. Работа с файлами в .NET 

Работа с файлами в .NET: основы, методы и классы, работа с текстовыми и бинарными файлами, работа с потоками, директориями, асинхронная обработка, обработка ошибок.

## Цели лекции

1. Дать полное понимание принципов работы с файлами в .NET.
2. Научить использовать классы `File`, `FileInfo`, `Directory`, `DirectoryInfo` для эффективной работы с файловой системой.
3. Научить чтению и записи файлов как синхронно, так и асинхронно.
4. Рассмотреть потоки и их использование при работе с большими файлами.
5. Обучить обработке ошибок и исключений при работе с файлами.
6. Продемонстрировать практические примеры и задачи, встречающиеся в реальных проектах.

---

## План лекции

1. **Введение в работу с файлами**
2. **Файловая система и пути к файлам**
3. **Классы .NET для работы с файлами и папками**
4. **Чтение и запись текстовых файлов**
5. **Чтение и запись бинарных файлов**
6. **Работа с потоками: FileStream, StreamReader, StreamWriter**
7. **Обработка больших файлов**
8. **Копирование, перемещение и удаление файлов**
9. **Работа с директориями и каталогами**
10. **Асинхронная работа с файлами**
11. **Обработка исключений при работе с файлами**
12. **Практические примеры**
13. **Советы по оптимизации и безопасности**
14. **Резюме**
15. **Контрольные вопросы**

---

## 1. Введение в работу с файлами

Файлы являются основным способом хранения данных на компьютере. В приложениях .NET файлы используются для:

* Хранения текстовой информации: отчёты, логи, конфигурации.
* Хранения бинарных данных: изображения, видео, аудио, базы данных.
* Обмена данными между приложениями.

При работе с файлами важно учитывать несколько аспектов:

* **Тип файла:** текстовый или бинарный.
* **Режим доступа:** чтение, запись, добавление.
* **Размер файла:** влияет на выбор метода чтения.
* **Ошибки ввода/вывода:** необходимо обрабатывать исключения.

Простая запись текста в файл через статический класс `File`:

```csharp
File.WriteAllText("notes.txt", "Добро пожаловать в .NET");
```

---

## 2. Файловая система и пути к файлам

В .NET путь к файлу можно задавать двумя способами:

* **Абсолютный путь** — полный путь, начиная с диска:
  `C:\Projects\example.txt`
* **Относительный путь** — относительно текущей директории приложения:
  `example.txt`

Особенности:

* Использовать `Path.Combine` для корректного объединения частей пути.
* Избегать ручного добавления слэшей (`\`), так как это может вызвать ошибки на разных ОС.

Пример корректного объединения пути:

```csharp
string folder = "Documents";
string fileName = "report.txt";
string fullPath = Path.Combine(folder, fileName);
```

---

## 3. Классы .NET для работы с файлами и папками

### 3.1 `File` и `FileInfo`

* **`File`** — статический класс, простой и удобный.
* **`FileInfo`** — экземплярный класс, даёт доступ к свойствам и информации о файле, например размер, дату создания, атрибуты.

Различие: `File` удобен для быстрого чтения/записи, `FileInfo` нужен, когда требуется работать с объектом файла и его свойствами.

### 3.2 `Directory` и `DirectoryInfo`

* **`Directory`** — статический класс для работы с папками.
* **`DirectoryInfo`** — экземплярный класс с расширенными возможностями, например, перечисление файлов и подпапок.

### 3.3 Потоки (`Stream`)

* **`FileStream`** — базовый поток для работы с файлами.
* **`StreamReader` и `StreamWriter`** — специализированные потоки для текстовых файлов.

---

## 4. Чтение и запись текстовых файлов

### 4.1 Синхронное чтение

Методы:

* `File.ReadAllText(path)` — возвращает весь текст файла.
* `File.ReadAllLines(path)` — возвращает массив строк.

```csharp
string content = File.ReadAllText("example.txt");
string[] lines = File.ReadAllLines("example.txt");
```

### 4.2 Синхронная запись

* `File.WriteAllText(path, text)` — запись текста, перезаписывает файл.
* `File.AppendAllText(path, text)` — добавление текста в конец файла.

```csharp
File.AppendAllText("example.txt", "Новая строка\n");
```

### 4.3 Потоковое чтение/запись

Используется при работе с большими файлами:

```csharp
using (StreamWriter writer = new StreamWriter("largefile.txt"))
{
    for (int i = 0; i < 1000; i++)
        writer.WriteLine($"Строка {i}");
}
```

---

## 5. Чтение и запись бинарных файлов

Бинарные файлы (например, изображения) нельзя читать как текст. Используются методы:

* `File.ReadAllBytes(path)` — чтение массива байт.
* `File.WriteAllBytes(path, byteArray)` — запись массива байт.

Пример копирования изображения:

```csharp
byte[] data = File.ReadAllBytes("photo.jpg");
File.WriteAllBytes("copy_photo.jpg", data);
```

---

## 6. Работа с потоками

Потоки позволяют работать с данными постепенно, что особенно важно для больших файлов.

### 6.1 `FileStream`

```csharp
using (FileStream fs = new FileStream("data.bin", FileMode.OpenOrCreate, FileAccess.Write))
{
    byte[] buffer = new byte[] { 0x1, 0x2, 0x3 };
    fs.Write(buffer, 0, buffer.Length);
}
```

### 6.2 `StreamReader` и `StreamWriter`

```csharp
using (StreamReader reader = new StreamReader("example.txt"))
{
    string line;
    while ((line = reader.ReadLine()) != null)
        Console.WriteLine(line);
}

using (StreamWriter writer = new StreamWriter("example.txt", true))
{
    writer.WriteLine("Добавленная строка");
}
```

---

## 7. Обработка больших файлов

* Использовать потоковое чтение (`StreamReader`) вместо `ReadAllText`, чтобы не загружать весь файл в память.
* Для бинарных файлов — `FileStream` с буферизацией:

```csharp
byte[] buffer = new byte[1024];
using (FileStream fs = new FileStream("large.bin", FileMode.Open))
{
    int bytesRead;
    while ((bytesRead = fs.Read(buffer, 0, buffer.Length)) > 0)
    {
        // Обработка данных
    }
}
```

---

## 8. Копирование, перемещение и удаление файлов

Методы:

* `File.Copy(source, destination, overwrite)`
* `File.Move(source, destination)`
* `File.Delete(path)`

Пример:

```csharp
File.Copy("example.txt", "backup.txt", true);
File.Move("example.txt", "archive.txt");
File.Delete("old.txt");
```

---

## 9. Работа с директориями

Создание папки:

```csharp
Directory.CreateDirectory("Reports");
```

Удаление папки с содержимым:

```csharp
Directory.Delete("Reports", true);
```

Перечисление файлов:

```csharp
string[] txtFiles = Directory.GetFiles("Reports", "*.txt");
```

---

## 10. Асинхронная работа с файлами

Асинхронные методы не блокируют главный поток приложения:

* `File.ReadAllTextAsync`
* `File.WriteAllTextAsync`
* `StreamReader.ReadLineAsync`

Пример:

```csharp
string content = await File.ReadAllTextAsync("example.txt");
await File.WriteAllTextAsync("output.txt", content);
```

---

## 11. Обработка исключений

При работе с файлами всегда нужно обрабатывать возможные ошибки:

* `FileNotFoundException`
* `DirectoryNotFoundException`
* `IOException`
* `UnauthorizedAccessException`

```csharp
try
{
    string text = File.ReadAllText("example.txt");
}
catch (FileNotFoundException ex)
{
    Console.WriteLine("Файл не найден: " + ex.Message);
}
catch (IOException ex)
{
    Console.WriteLine("Ошибка ввода/вывода: " + ex.Message);
}
```

---

## 12. Практические примеры

1. **Логирование событий:**

```csharp
using (StreamWriter writer = new StreamWriter("log.txt", true))
{
    writer.WriteLine($"{DateTime.Now}: Событие произошло");
}
```

2. **Резервное копирование файлов:**

```csharp
string[] files = Directory.GetFiles("Data");
foreach (string file in files)
{
    string dest = Path.Combine("Backup", Path.GetFileName(file));
    File.Copy(file, dest, true);
}
```

3. **Чтение CSV-файлов:**

```csharp
string[] lines = File.ReadAllLines("data.csv");
foreach (string line in lines)
{
    string[] values = line.Split(',');
    Console.WriteLine($"Имя: {values[0]}, Возраст: {values[1]}");
}
```

---

## 13. Советы по оптимизации и безопасности

* Использовать потоковое чтение для больших файлов.
* Закрывать потоки через `using`.
* Проверять права доступа к файлам.
* Избегать одновременной записи в один файл из нескольких потоков.
* Для логирования и временных файлов использовать отдельные папки.

---

## 14. Резюме

* В .NET можно работать с файлами через статические методы и объекты.
* Для больших файлов применяются потоки.
* Важно обрабатывать исключения и освобождать ресурсы.
* Асинхронная работа повышает отзывчивость приложений.
* Работа с директориями и файлами позволяет организовать структуру данных.

---

## 15. Контрольные вопросы

1. Чем отличается `File` от `FileInfo`?
2. Какие методы существуют для чтения и записи текстовых файлов?
3. Почему важно использовать потоки при больших файлах?
4. Как правильно обрабатывать ошибки при работе с файлами?
5. Приведите пример асинхронного чтения файла.
6. Как получить список всех файлов с расширением `.txt` в папке?
7. В чем разница между бинарными и текстовыми файлами?
8. Как переместить файл с перезаписью, если он уже существует?
9. Какие меры безопасности нужно соблюдать при работе с файлами?
