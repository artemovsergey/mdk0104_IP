# Лекция 15. Entity Framework Core

### Цель лекции:

Познакомить студентов с принципами работы Entity Framework Core, его архитектурой, возможностями работы с базой данных, особенностями конфигурации моделей, миграциями, запросами, производительностью и практическим применением в проектах .NET.

### План лекции:

1. **Введение в ORM и EF Core**
2. **Архитектура Entity Framework Core**
3. **Модели данных и контексты базы данных**
4. **Конфигурация моделей и Fluent API**
5. **Миграции и управление схемой базы данных**
6. **CRUD-операции в EF Core**
7. **Запросы к базе данных: LINQ и IQueryable**
8. **Отношения между сущностями**
9. **Производительность и оптимизация**
10. **Реальные сценарии использования EF Core**
11. **Резюме**
12. **Контрольные вопросы**

---

## 1. Введение в ORM и EF Core

Entity Framework Core (EF Core) — это объектно-реляционная mapper (ORM), который позволяет разработчикам .NET работать с базой данных через объектную модель. Основная цель EF Core — избавить разработчика от необходимости писать SQL-запросы вручную для большинства операций и при этом предоставить возможность гибкого взаимодействия с базой данных.

ORM (Object-Relational Mapping) — это технология, которая преобразует объекты языка программирования в записи базы данных и обратно.

Преимущества использования EF Core:

* **Сокращение количества кода**: вместо ручного написания SQL можно использовать C# и LINQ.
* **Поддержка различных СУБД**: SQL Server, SQLite, PostgreSQL, MySQL и другие через провайдеры.
* **Миграции базы данных**: удобное управление схемой базы данных.
* **Гибкая настройка и расширяемость**: Fluent API, Data Annotations.

**Пример использования EF Core**:

```csharp
public class Product
{
    public int Id { get; set; }
    public string Name { get; set; }
    public decimal Price { get; set; }
}

public class AppDbContext : DbContext
{
    public DbSet<Product> Products { get; set; }

    protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)
    {
        optionsBuilder.UseSqlServer("Server=.;Database=ShopDb;Trusted_Connection=True;");
    }
}
```

Здесь `Product` — это сущность, а `AppDbContext` — контекст базы данных.

---

## 2. Архитектура Entity Framework Core

EF Core состоит из нескольких ключевых компонентов:

1. **DbContext** — основной класс для взаимодействия с базой данных. Отвечает за:

   * Управление сущностями.
   * Отслеживание изменений (Change Tracking).
   * Выполнение запросов и сохранение изменений (`SaveChanges`).

2. **DbSet<TEntity>** — коллекция объектов сущностей, которые можно считывать, добавлять, удалять и обновлять.

3. **Модели данных (Model)** — представление структуры таблиц базы данных и связей между ними в виде объектов C#.

4. **Поставщики баз данных (Database Providers)** — адаптеры для конкретных СУБД, например `Microsoft.EntityFrameworkCore.SqlServer`.

5. **Change Tracker** — механизм, который отслеживает изменения объектов, чтобы корректно формировать SQL-запросы для сохранения изменений.

**Пример архитектуры**:

```csharp
using var context = new AppDbContext();

// Добавление новой сущности
var product = new Product { Name = "Laptop", Price = 1500 };
context.Products.Add(product);
context.SaveChanges();

// Извлечение данных
var products = context.Products.ToList();
```

---

## 3. Модели данных и контексты базы данных

### 3.1. Определение сущностей

Сущности (Entities) представляют таблицы базы данных. Каждое свойство класса — это колонка таблицы.

```csharp
public class Customer
{
    public int Id { get; set; }
    public string FullName { get; set; }
    public string Email { get; set; }
}
```

### 3.2. Создание контекста базы данных

`DbContext` представляет сеанс работы с базой данных. Он должен содержать DbSet для каждой сущности.

```csharp
public class ShopContext : DbContext
{
    public DbSet<Customer> Customers { get; set; }

    protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)
    {
        optionsBuilder.UseSqlServer("Server=.;Database=ShopDb;Trusted_Connection=True;");
    }
}
```

### 3.3. Подходы к созданию модели

EF Core поддерживает два основных подхода:

1. **Code First** — сначала пишем классы C#, а база данных создается на их основе.
2. **Database First** — база данных уже существует, и EF Core генерирует классы на основе схемы.

---

## 4. Конфигурация моделей и Fluent API

Для настройки модели EF Core можно использовать:

1. **Data Annotations** — атрибуты над свойствами и классами.
2. **Fluent API** — программная конфигурация в методе `OnModelCreating`.

**Примеры Data Annotations**:

```csharp
public class Customer
{
    [Key]
    public int Id { get; set; }

    [Required]
    [MaxLength(100)]
    public string FullName { get; set; }

    [EmailAddress]
    public string Email { get; set; }
}
```

**Примеры Fluent API**:

```csharp
protected override void OnModelCreating(ModelBuilder modelBuilder)
{
    modelBuilder.Entity<Customer>()
        .Property(c => c.FullName)
        .IsRequired()
        .HasMaxLength(100);

    modelBuilder.Entity<Customer>()
        .HasIndex(c => c.Email)
        .IsUnique();
}
```

---

## 5. Миграции и управление схемой базы данных

Миграции позволяют синхронизировать код и базу данных.

### 5.1. Основные команды EF Core CLI:

```bash
dotnet ef migrations add InitialCreate
dotnet ef database update
```

### 5.2. Пример добавления новой сущности

```csharp
public class Order
{
    public int Id { get; set; }
    public int CustomerId { get; set; }
    public Customer Customer { get; set; }
    public DateTime OrderDate { get; set; }
}
```

Создаем миграцию:

```bash
dotnet ef migrations add AddOrders
dotnet ef database update
```

---

## 6. CRUD-операции в EF Core

### 6.1. Создание (Create)

```csharp
var customer = new Customer { FullName = "John Doe", Email = "john@example.com" };
context.Customers.Add(customer);
context.SaveChanges();
```

### 6.2. Чтение (Read)

```csharp
var customer = context.Customers.FirstOrDefault(c => c.Email == "john@example.com");
```

### 6.3. Обновление (Update)

```csharp
customer.FullName = "John Smith";
context.SaveChanges();
```

### 6.4. Удаление (Delete)

```csharp
context.Customers.Remove(customer);
context.SaveChanges();
```

---

## 7. Запросы к базе данных: LINQ и IQueryable

EF Core позволяет использовать **LINQ** для написания запросов к базе данных.

**Примеры запросов**:

```csharp
// Получить всех клиентов с ценой заказа > 100
var customers = context.Customers
    .Where(c => c.Orders.Any(o => o.Total > 100))
    .ToList();

// Проекция: только имена клиентов
var names = context.Customers
    .Select(c => c.FullName)
    .ToList();
```

**Отличие IQueryable и IEnumerable**:

* `IQueryable` — запрос формируется и выполняется на стороне базы данных.
* `IEnumerable` — обработка происходит в памяти после выборки данных.

---

## 8. Отношения между сущностями

EF Core поддерживает три типа отношений:

1. **Один-к-одному (1:1)**

```csharp
public class User
{
    public int Id { get; set; }
    public UserProfile Profile { get; set; }
}

public class UserProfile
{
    public int Id { get; set; }
    public string Bio { get; set; }
    public int UserId { get; set; }
    public User User { get; set; }
}
```

2. **Один-ко-многим (1:N)**

```csharp
public class Customer
{
    public int Id { get; set; }
    public ICollection<Order> Orders { get; set; }
}

public class Order
{
    public int Id { get; set; }
    public int CustomerId { get; set; }
    public Customer Customer { get; set; }
}
```

3. **Многие-ко-многим (N:N)**

```csharp
public class Student
{
    public int Id { get; set; }
    public ICollection<Course> Courses { get; set; }
}

public class Course
{
    public int Id { get; set; }
    public ICollection<Student> Students { get; set; }
}
```

---

## 9. Производительность и оптимизация

Основные методы оптимизации:

1. **Отложенная загрузка (Lazy Loading)**
2. **Жадная загрузка (Eager Loading)** с помощью `Include`

```csharp
var orders = context.Orders
    .Include(o => o.Customer)
    .ToList();
```

3. **Выборочные загрузки (Select)** — выбирать только нужные поля

```csharp
var customerNames = context.Customers
    .Select(c => new { c.Id, c.FullName })
    .ToList();
```

4. **AsNoTracking** — отключает отслеживание изменений для ускорения чтения

```csharp
var customers = context.Customers
    .AsNoTracking()
    .ToList();
```

---

## 10. Реальные сценарии использования EF Core

* Веб-приложения на ASP.NET Core
* API для мобильных приложений
* Консольные приложения для обработки данных
* Микросервисы с отдельными базами данных

**Пример интеграции с ASP.NET Core**:

```csharp
public void ConfigureServices(IServiceCollection services)
{
    services.AddDbContext<ShopContext>(options =>
        options.UseSqlServer(Configuration.GetConnectionString("DefaultConnection")));
}
```

---

## 11. Резюме

Entity Framework Core — мощный инструмент для работы с базами данных в .NET. Он позволяет:

* Работать с базой данных через объектную модель.
* Автоматизировать создание и обновление схемы базы данных с помощью миграций.
* Писать запросы с помощью LINQ.
* Управлять отношениями между сущностями.
* Оптимизировать работу с данными с помощью различных техник загрузки и отслеживания изменений.

EF Core подходит как для небольших проектов, так и для больших корпоративных решений.

---

## 12. Контрольные вопросы

1. Что такое ORM и зачем он нужен?
2. Чем отличается DbContext от DbSet?
3. Какие подходы создания модели поддерживает EF Core?
4. Как реализовать один-ко-многим отношение между сущностями?
5. В чем разница между `IQueryable` и `IEnumerable`?
6. Какие способы оптимизации запросов существуют в EF Core?
7. Как использовать миграции для обновления схемы базы данных?
8. Что такое Fluent API и чем он отличается от Data Annotations?
9. Какие типы отношений между сущностями поддерживает EF Core?
10. Как интегрировать EF Core с ASP.NET Core?