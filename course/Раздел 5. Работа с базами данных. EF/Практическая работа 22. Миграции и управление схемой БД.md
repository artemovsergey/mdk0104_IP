# Практическая работа 22. Миграции и управление схемой базы данных в EF Core

Использование **миграций** для создания и управления схемой базы данных в проектах .NET с использованием **Entity Framework Core**.

### Цель:

* Научиться создавать миграции и обновлять базу данных.
* Освоить управление схемой базы данных через EF Core.
* Практически применять подход **CodeFirst** для модификации структуры таблиц.
* Познакомиться с командами EF Core для управления миграциями.

---

## Теоретическая часть

### 1. Что такое миграции

Миграции в EF Core — это механизм управления схемой базы данных на основе изменений моделей данных. Основная идея:

* Миграции позволяют создавать новые таблицы, изменять существующие или удалять их.
* Все изменения отражаются в базе данных без необходимости вручную писать SQL-код.
* Каждая миграция фиксирует текущее состояние моделей и может быть применена или отменена.

### 2. Основные команды EF Core для миграций

| Команда                           | Описание                                  |
| --------------------------------- | ----------------------------------------- |
| `dotnet ef migrations add <Name>` | Создание новой миграции с именем `<Name>` |
| `dotnet ef database update`       | Применение миграции к базе данных         |
| `dotnet ef migrations remove`     | Удаление последней миграции               |
| `dotnet ef migrations list`       | Просмотр списка всех миграций             |
| `dotnet ef database drop`         | Удаление базы данных                      |

### 3. CodeFirst и миграции

При подходе CodeFirst сначала создаются модели данных в коде, затем с помощью миграций база данных создаётся и модифицируется автоматически.

---

## Ход работы

1. Выбрать вариант задания по номеру в журнале.
2. Создать проект .NET (консольный, WinForms или ASP.NET Core).
3. Создать модели данных и DbContext.
4. Создать первую миграцию (`InitialCreate`) и обновить базу данных.
5. Добавить новое свойство или сущность, создать новую миграцию (`AddColumnOrEntity`) и применить изменения.
6. При необходимости откатить миграцию или удалить её.
7. Сделать скриншоты работы программы и изменений базы данных, поместить их в папку `images`.
8. Создать файл `readme.md` с номером практической работы, вариантом, текстом задания и оформленным кодом.
9. Сохранить проект в репозиторий.

---

## Практический пример

**1. Создание модели `Product`:**

```csharp
public class Product
{
    public int Id { get; set; }
    public string Name { get; set; }
    public decimal Price { get; set; }
}
```

**2. DbContext:**

```csharp
public class ShopContext : DbContext
{
    public DbSet<Product> Products { get; set; }

    protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)
    {
        optionsBuilder.UseSqlServer("Server=.;Database=ShopDb;Trusted_Connection=True;");
    }
}
```

**3. Создание первой миграции:**

```bash
dotnet ef migrations add InitialCreate
dotnet ef database update
```

**4. Добавление нового свойства `Description` в модель:**

```csharp
public class Product
{
    public int Id { get; set; }
    public string Name { get; set; }
    public decimal Price { get; set; }
    public string Description { get; set; } // новое свойство
}
```

**5. Создание новой миграции и обновление базы данных:**

```bash
dotnet ef migrations add AddDescriptionToProduct
dotnet ef database update
```

**6. Откат последней миграции:**

```bash
dotnet ef database update InitialCreate
dotnet ef migrations remove
```

---

## 15 вариантов заданий

1. Создать модель `Product` с миграцией `InitialCreate`.
2. Добавить новую колонку `Description` в `Product` через миграцию.
3. Создать модель `Customer` и применить миграцию.
4. Добавить новое свойство `Email` в `Customer`.
5. Создать модель `Order` и применить миграцию.
6. Добавить связь один-ко-многим между `Customer` и `Order` через миграцию.
7. Создать модель `Student` и применить миграцию.
8. Добавить свойство `Age` в `Student`.
9. Создать модель `Teacher` и применить миграцию.
10. Добавить связь один-ко-многим между `Teacher` и `Course`.
11. Создать модель `Book` и применить миграцию.
12. Добавить свойство `Author` в `Book`.
13. Создать модель `Employee` и применить миграцию.
14. Добавить колонку `Salary` в `Employee`.
15. Создать модель `Invoice` и применить миграцию, добавить колонку `Amount` позже.

---

## Критерии оценки

| Оценка | Критерий                                                                                               |
| ------ | ------------------------------------------------------------------------------------------------------ |
| 5      | Все миграции созданы корректно, база обновлена, изменения отображаются в базе, есть скриншоты и readme |
| 4      | Все миграции созданы, но есть небольшие недочеты, база работает, есть скриншоты/readme                 |
| 3      | Миграции частично созданы, база обновлена с ошибками или отсутствуют скриншоты/readme                  |
| 2      | Миграции созданы частично, база не обновлена, нет скриншотов/readme                                    |
| 1      | Работа не сдана или проект не запускается                                                              |

---

## Контрольные вопросы

1. Что такое миграции в EF Core и для чего они нужны?
2. Какие команды создают и применяют миграции?
3. Как откатить последнюю миграцию?
4. Чем отличается `InitialCreate` от последующих миграций?
5. Как добавлять новые колонки или сущности через миграции?
6. Что такое подход CodeFirst и как он связан с миграциями?
7. Как проверить список всех миграций проекта?
8. Можно ли удалять миграции после их применения?
9. Как управлять схемой базы данных без потери данных?
10. Какие файлы должны быть включены в репозиторий при сдаче работы?

---

## Структура репозитория

```
ПрактическаяРабота22/
│
├─ Project/                  # Проект приложения (ConsoleApp, WinForms, ASP.NET Core)
│
├─ images/                   # Скриншоты работы программы и схемы базы данных
│
└─ readme.md                 # Номер работы, вариант, текст задания, пример кода
```

**Пример readme.md:**

````markdown
# Практическая работа №22
## Тема: Миграции и управление схемой БД
### Вариант 3

**Задание:** Создать модель `Product` с колонками Id, Name, Price. Добавить новую колонку `Description` через миграцию.

```csharp
public class Product
{
    public int Id { get; set; }
    public string Name { get; set; }
    public decimal Price { get; set; }
    public string Description { get; set; } // добавленная колонка
}
````

```bash
dotnet ef migrations add InitialCreate
dotnet ef database update

dotnet ef migrations add AddDescriptionToProduct
dotnet ef database update
```

```