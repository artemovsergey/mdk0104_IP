# Практическая работа 24. Транзакции и паттерн Unit of Work в EF Core

Использование **транзакций** и реализация паттерна **Unit of Work (UoW)** для управления изменениями в базе данных через **Entity Framework Core**.

### Цель:

* Понять концепцию транзакций в базах данных и их применение в EF Core.
* Освоить паттерн Unit of Work для координации работы с несколькими репозиториями.
* Практически реализовать управление сохранением изменений с помощью UoW и транзакций.
* Закрепить навыки работы с CRUD-операциями в рамках одной атомарной операции.

---

## Теоретическая часть

### 1. Транзакции

Транзакция — это атомарная единица работы с базой данных, которая либо полностью выполняется, либо полностью откатывается при ошибке.

**Основные свойства транзакций (ACID):**

* **Atomicity (Атомарность)** — либо все операции выполняются, либо ни одна.
* **Consistency (Согласованность)** — база данных остается в согласованном состоянии.
* **Isolation (Изоляция)** — результаты транзакции видны только после её завершения.
* **Durability (Надёжность)** — после успешного завершения изменения сохраняются навсегда.

**Пример транзакции в EF Core:**

```csharp
using var context = new ShopContext();
using var transaction = await context.Database.BeginTransactionAsync();

try
{
    var product = new Product { Name = "Laptop", Price = 1500 };
    context.Products.Add(product);

    var order = new Order { CustomerId = 1, TotalAmount = 1500 };
    context.Orders.Add(order);

    await context.SaveChangesAsync();
    await transaction.CommitAsync();
}
catch
{
    await transaction.RollbackAsync();
    Console.WriteLine("Произошла ошибка. Транзакция откатана.");
}
```

---

### 2. Паттерн Unit of Work (UoW)

Unit of Work — это паттерн, обеспечивающий координацию работы с репозиториями и управление транзакциями.

**Принцип работы:**

* Все изменения в рамках одного Unit of Work фиксируются одной транзакцией.
* Позволяет управлять несколькими репозиториями как единым блоком.
* Упрощает откат изменений при ошибках.

**Пример интерфейса UoW:**

```csharp
public interface IUnitOfWork : IDisposable
{
    IProductRepository Products { get; }
    IOrderRepository Orders { get; }
    Task<int> CompleteAsync();
}
```

**Реализация Unit of Work:**

```csharp
public class UnitOfWork : IUnitOfWork
{
    private readonly ShopContext _context;
    public IProductRepository Products { get; private set; }
    public IOrderRepository Orders { get; private set; }

    public UnitOfWork(ShopContext context)
    {
        _context = context;
        Products = new ProductRepository(_context);
        Orders = new OrderRepository(_context);
    }

    public async Task<int> CompleteAsync()
    {
        return await _context.SaveChangesAsync();
    }

    public void Dispose()
    {
        _context.Dispose();
    }
}
```

**Пример использования UoW:**

```csharp
using var unitOfWork = new UnitOfWork(new ShopContext());

var product = new Product { Name = "Laptop", Price = 1500 };
unitOfWork.Products.Add(product);

var order = new Order { CustomerId = 1, TotalAmount = 1500 };
unitOfWork.Orders.Add(order);

await unitOfWork.CompleteAsync();
```

---

## Ход работы

1. Выбрать вариант задания по номеру в журнале.
2. Создать проект .NET (консольный, WinForms или ASP.NET Core).
3. Создать модели данных: `Product`, `Order`, `Customer` и другие.
4. Создать репозитории для каждой сущности.
5. Реализовать интерфейс Unit of Work и класс `UnitOfWork`.
6. Выполнить несколько операций CRUD через UoW в рамках одной транзакции.
7. Обработать возможные ошибки и откаты транзакций.
8. Сделать скриншоты работы программы и положить их в папку `images`.
9. Создать файл `readme.md` с номером работы, вариантом, текстом задания и примерами кода.
10. Сохранить проект в репозиторий.

---

## Практический пример

**Модель Product:**

```csharp
public class Product
{
    public int Id { get; set; }
    public string Name { get; set; }
    public decimal Price { get; set; }
}
```

**Пример репозитория:**

```csharp
public class ProductRepository : IProductRepository
{
    private readonly ShopContext _context;
    public ProductRepository(ShopContext context)
    {
        _context = context;
    }

    public void Add(Product product) => _context.Products.Add(product);
    public void Remove(Product product) => _context.Products.Remove(product);
    public IEnumerable<Product> GetAll() => _context.Products.ToList();
}
```

**Использование Unit of Work:**

```csharp
using var unitOfWork = new UnitOfWork(new ShopContext());

var product = new Product { Name = "Phone", Price = 800 };
unitOfWork.Products.Add(product);

var order = new Order { CustomerId = 1, TotalAmount = 800 };
unitOfWork.Orders.Add(order);

try
{
    await unitOfWork.CompleteAsync();
    Console.WriteLine("Транзакция выполнена успешно.");
}
catch
{
    Console.WriteLine("Произошла ошибка. Все изменения откатаны.");
}
```

---

## 15 вариантов заданий

1. Реализовать UoW для сущностей `Product` и `Order`.
2. Создать транзакцию добавления продукта и заказа одновременно.
3. Добавить репозиторий `Customer` и включить в UoW.
4. Выполнить откат транзакции при ошибке при добавлении заказа.
5. Использовать UoW для обновления цены продукта и суммы заказа.
6. Реализовать удаление продукта и связанных заказов в рамках одной транзакции.
7. Создать несколько UoW для разных операций и сравнить результаты.
8. Добавить проверку уникальности заказов перед сохранением через UoW.
9. Реализовать метод `CompleteAsync` с обработкой ошибок.
10. Использовать транзакцию для изменения нескольких сущностей одновременно.
11. Создать отчёт по продуктам и заказам в одной транзакции.
12. Добавить логирование транзакций в UoW.
13. Демонстрация параллельного использования UoW для нескольких пользователей.
14. Использовать UoW с асинхронными CRUD-операциями.
15. Сравнить использование транзакций напрямую и через UoW.

---

## Критерии оценки

| Оценка | Критерий                                                                                  |
| ------ | ----------------------------------------------------------------------------------------- |
| 5      | Все операции выполнены корректно, транзакции и UoW работают, есть скриншоты и readme      |
| 4      | Работа выполнена с незначительными недочетами, скриншоты/readme присутствуют              |
| 3      | Частично выполнено, транзакции/UoW работают не полностью, нет некоторых скриншотов/readme |
| 2      | Работа выполнена частично, транзакции/UoW не работают, отсутствуют скриншоты/readme       |
| 1      | Работа не сдана или проект не запускается                                                 |

---

## Контрольные вопросы

1. Что такое транзакция и зачем она нужна?
2. Какие свойства транзакции обозначает ACID?
3. Что такое паттерн Unit of Work?
4. Как UoW координирует работу с репозиториями?
5. Как откатить транзакцию при ошибке?
6. Чем отличается использование транзакций напрямую от UoW?
7. Какие преимущества даёт использование UoW при сложных операциях?
8. Как обрабатывать ошибки при вызове `CompleteAsync`?
9. Как объединять несколько операций CRUD в одной транзакции через UoW?
10. Какие файлы должны быть включены в репозиторий при сдаче работы?

---

## Структура репозитория

```
ПрактическаяРабота24/
│
├─ Project/                  # Проект приложения (ConsoleApp, ASP.NET Core)
│
├─ images/                   # Скриншоты работы программы и демонстрации транзакций
│
└─ readme.md                 # Номер работы, вариант, текст задания, пример кода
```

**Пример readme.md:**

````markdown
# Практическая работа №24
## Тема: Транзакции и паттерн Unit of Work
### Вариант 3

**Задание:** Реализовать Unit of Work для сущностей Product и Order. Выполнить транзакцию добавления продукта и заказа одновременно.

```csharp
using var unitOfWork = new UnitOfWork(new ShopContext());

var product = new Product { Name = "Phone", Price = 800 };
unitOfWork.Products.Add(product);

var order = new Order { CustomerId = 1, TotalAmount = 800 };
unitOfWork.Orders.Add(order);

await unitOfWork.CompleteAsync();
````

```