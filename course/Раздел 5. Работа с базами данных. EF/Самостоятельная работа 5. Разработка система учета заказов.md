# Самостоятельная работа 5. Разработка системы учёта заказов

Разработка **системы учёта заказов** с использованием **Entity Framework Core** и подхода **CodeFirst** в .NET.

### Цель:

* Научиться проектировать и создавать модели данных для системы учёта заказов.
* Освоить CRUD-операции для работы с заказами, клиентами и продуктами.
* Практически реализовать систему с хранением и обработкой данных в базе.
* Закрепить навыки работы с миграциями, транзакциями и репозиториями.

---

## Теоретическая часть

### 1. Основные сущности системы учёта заказов

Для работы системы учёта заказов обычно выделяют следующие основные сущности:

| Сущность  | Поля                                    | Описание                                  |
| --------- | --------------------------------------- | ----------------------------------------- |
| Customer  | Id, FullName, Email, Phone              | Клиент, делающий заказ                    |
| Product   | Id, Name, Price, Stock                  | Товар или услуга, доступная для заказа    |
| Order     | Id, CustomerId, OrderDate, TotalAmount  | Заказ клиента                             |
| OrderItem | Id, OrderId, ProductId, Quantity, Price | Детали заказа, связывает заказ и продукты |

Связи между сущностями:

* **Customer – Order**: один-ко-многим
* **Order – OrderItem**: один-ко-многим
* **Product – OrderItem**: один-ко-многим

---

### 2. CRUD-операции в системе

**CRUD-операции** позволяют работать с данными:

* **Create**: добавление новых клиентов, продуктов и заказов.
* **Read**: получение информации о клиентах, заказах и товарах.
* **Update**: изменение данных существующих клиентов, продуктов и заказов.
* **Delete**: удаление клиентов, заказов и продуктов при необходимости.

Пример создания заказа с элементами:

```csharp
using var context = new ShopContext();

var customer = new Customer { FullName = "John Doe", Email = "john@example.com", Phone = "1234567890" };
context.Customers.Add(customer);

var product1 = new Product { Name = "Laptop", Price = 1500, Stock = 10 };
var product2 = new Product { Name = "Mouse", Price = 50, Stock = 100 };
context.Products.AddRange(product1, product2);

var order = new Order
{
    Customer = customer,
    OrderDate = DateTime.Now,
    TotalAmount = 1550,
    OrderItems = new List<OrderItem>
    {
        new OrderItem { Product = product1, Quantity = 1, Price = 1500 },
        new OrderItem { Product = product2, Quantity = 1, Price = 50 }
    }
};

context.Orders.Add(order);
context.SaveChanges();
```

---

### 3. Миграции и создание базы данных

Используется подход **CodeFirst**:

```bash
dotnet ef migrations add InitialCreate
dotnet ef database update
```

Эти команды создают таблицы и связи на основе моделей.

---

### 4. Транзакции

Создание заказа и обновление склада продуктов следует выполнять в рамках транзакции, чтобы обеспечить целостность данных:

```csharp
using var transaction = await context.Database.BeginTransactionAsync();
try
{
    // Создание заказа и изменение запасов
    context.Orders.Add(order);
    foreach (var item in order.OrderItems)
    {
        item.Product.Stock -= item.Quantity;
    }

    await context.SaveChangesAsync();
    await transaction.CommitAsync();
}
catch
{
    await transaction.RollbackAsync();
    Console.WriteLine("Ошибка при создании заказа. Операция откатана.");
}
```

---

### 5. Оптимизация запросов

* Использовать `Include` для загрузки связанных данных:

```csharp
var orders = context.Orders
                    .Include(o => o.Customer)
                    .Include(o => o.OrderItems)
                        .ThenInclude(oi => oi.Product)
                    .ToList();
```

* Использовать `AsNoTracking` для операций только чтения.

---

## Ход работы

1. Создать проект .NET (консольный или ASP.NET Core).
2. Создать модели: `Customer`, `Product`, `Order`, `OrderItem`.
3. Настроить связи между сущностями через Fluent API или Data Annotations.
4. Создать первую миграцию и обновить базу данных.
5. Реализовать CRUD-операции для всех сущностей.
6. Реализовать добавление заказов с элементами и обновление складских остатков в транзакции.
7. Реализовать просмотр заказов с детализацией и суммами.
8. Сделать скриншоты работы программы и положить их в папку `images`.
9. Создать файл `readme.md` с описанием работы и примерами кода.
10. Сохранить проект в репозиторий.

---

## Практический пример

**Модель Customer:**

```csharp
public class Customer
{
    public int Id { get; set; }
    public string FullName { get; set; }
    public string Email { get; set; }
    public string Phone { get; set; }

    public ICollection<Order> Orders { get; set; }
}
```

**Модель OrderItem:**

```csharp
public class OrderItem
{
    public int Id { get; set; }
    public int OrderId { get; set; }
    public Order Order { get; set; }

    public int ProductId { get; set; }
    public Product Product { get; set; }

    public int Quantity { get; set; }
    public decimal Price { get; set; }
}
```

**DbContext:**

```csharp
public class ShopContext : DbContext
{
    public DbSet<Customer> Customers { get; set; }
    public DbSet<Product> Products { get; set; }
    public DbSet<Order> Orders { get; set; }
    public DbSet<OrderItem> OrderItems { get; set; }

    protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)
    {
        optionsBuilder.UseSqlServer("Server=.;Database=ShopDb;Trusted_Connection=True;");
    }
}
```

---

## Критерии оценки

| Оценка | Критерий                                                                                                        |
| ------ | --------------------------------------------------------------------------------------------------------------- |
| 5      | Система работает полностью: CRUD, транзакции, миграции, корректное отображение заказов, есть скриншоты и readme |
| 4      | Система работает с незначительными недочетами или пропущены отдельные функции, есть скриншоты/readme            |
| 3      | Основная функциональность выполнена, но есть ошибки, скриншоты/readme частично                                  |
| 2      | Система частично работает, основные функции отсутствуют, скриншоты/readme отсутствуют                           |
| 1      | Работа не сдана или проект не запускается                                                                       |

---

## Контрольные вопросы

1. Какие основные сущности включает система учёта заказов?
2. Как реализовать CRUD-операции для заказов?
3. Как настроить связи один-ко-многим и многие-ко-многим?
4. Как использовать миграции для создания базы данных?
5. Как обеспечить целостность данных при создании заказа с несколькими элементами?
6. В чем преимущество транзакций при работе с заказами и складом?
7. Как загрузить заказы с детализацией продуктов и клиентов?
8. Как использовать оптимизацию запросов через Include и AsNoTracking?
9. Какие шаги нужно выполнить для корректного сохранения заказов с транзакцией?
10. Какие файлы должны быть включены в репозиторий при сдаче работы?

---

## Структура репозитория

```
СамостоятельнаяРабота5/
│
├─ Project/                  # Проект приложения (ConsoleApp, ASP.NET Core)
│
├─ images/                   # Скриншоты работы программы и отчетов
│
└─ readme.md                 # Описание работы и примеры кода
```

**Пример readme.md:**

````markdown
# Самостоятельная работа №5
## Тема: Разработка системы учёта заказов

**Описание работы:** Разработать систему учета заказов с сущностями Customer, Product, Order и OrderItem. Реализовать CRUD-операции, добавление заказов с элементами и обновление складских остатков в транзакции.

```csharp
using var context = new ShopContext();
var customer = new Customer { FullName = "John Doe", Email = "john@example.com", Phone = "1234567890" };
context.Customers.Add(customer);

var product = new Product { Name = "Laptop", Price = 1500, Stock = 10 };
context.Products.Add(product);

var order = new Order
{
    Customer = customer,
    OrderDate = DateTime.Now,
    TotalAmount = 1500,
    OrderItems = new List<OrderItem>
    {
        new OrderItem { Product = product, Quantity = 1, Price = 1500 }
    }
};

context.Orders.Add(order);
context.SaveChanges();
````

```