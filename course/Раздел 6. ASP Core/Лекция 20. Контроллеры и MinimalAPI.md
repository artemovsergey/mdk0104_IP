# Лекция 20. Контроллеры и Minimal API в ASP.NET Core

## План лекции

1. **Введение в ASP.NET Core Web API**

   * Что такое Web API
   * Роль контроллеров и API
   * Отличие от классических веб-приложений

2. **Контроллеры в ASP.NET Core**

   * MVC-подход
   * Атрибуты маршрутизации
   * Контроллеры и действия
   * Обработка запросов и возвращаемые типы

3. **Примеры работы с контроллерами**

   * CRUD-приложение с ProductController
   * Использование сервисов через Dependency Injection
   * Возврат данных в формате JSON

4. **Minimal API в ASP.NET Core**

   * Что такое Minimal API
   * Отличия от контроллеров
   * Преимущества и ограничения

5. **Примеры Minimal API**

   * Определение маршрутов
   * Обработка HTTP-запросов
   * Работа с сервисами через DI

6. **Сравнение контроллеров и Minimal API**

   * Когда использовать контроллеры
   * Когда предпочтительнее Minimal API
   * Производительность и простота

7. **Обработка ошибок и валидация**

   * Валидация входных данных
   * Обработка исключений
   * Использование фильтров и Middleware

8. **Резюме и выводы**

9. **Контрольные вопросы**

---

## Подробное содержание лекции

### 1. Введение в ASP.NET Core Web API

Web API — это приложение, предоставляющее интерфейс для обмена данными через HTTP. API может использоваться фронтендом, мобильными приложениями или другими сервисами.

**Особенности Web API:**

* Отсутствие представлений (View)
* Работа с JSON или XML
* Стандартизированные HTTP-методы: GET, POST, PUT, DELETE

**Пример запроса к API:**

```
GET /api/products
POST /api/products
PUT /api/products/1
DELETE /api/products/1
```

---

### 2. Контроллеры в ASP.NET Core

Контроллеры — это классы, которые обрабатывают HTTP-запросы и возвращают ответы.

**Основные концепции:**

* Наследование от `ControllerBase` или `Controller`
* Методы называются действиями (Actions)
* Маршрутизация через атрибуты `[Route]` и `[HttpGet]`, `[HttpPost]`

**Пример контроллера:**

```csharp
[ApiController]
[Route("api/[controller]")]
public class ProductsController : ControllerBase
{
    private readonly IProductService _service;

    public ProductsController(IProductService service)
    {
        _service = service;
    }

    [HttpGet]
    public IActionResult GetAll()
    {
        var products = _service.GetAll();
        return Ok(products);
    }

    [HttpGet("{id}")]
    public IActionResult GetById(int id)
    {
        var product = _service.GetById(id);
        if (product == null) return NotFound();
        return Ok(product);
    }

    [HttpPost]
    public IActionResult Create(Product product)
    {
        _service.Add(product);
        return CreatedAtAction(nameof(GetById), new { id = product.Id }, product);
    }

    [HttpPut("{id}")]
    public IActionResult Update(int id, Product product)
    {
        if (id != product.Id) return BadRequest();
        _service.Update(product);
        return NoContent();
    }

    [HttpDelete("{id}")]
    public IActionResult Delete(int id)
    {
        _service.Delete(id);
        return NoContent();
    }
}
```

---

### 3. Примеры работы с контроллерами

**Использование сервисов через DI:**

* Контроллер получает сервис через конструктор
* Все бизнес-операции выполняются в сервисе, контроллер только делегирует

**Возврат данных в формате JSON:**

* Методы возвращают `IActionResult`
* Встроенный сериализатор JSON конвертирует объекты автоматически

**Пример запроса и ответа:**

```
GET /api/products
Response: [
  { "id": 1, "name": "Book", "price": 9.99 },
  { "id": 2, "name": "Pen", "price": 1.99 }
]
```

---

### 4. Minimal API в ASP.NET Core

**Что такое Minimal API:**

* Новый подход с .NET 6
* Позволяет создавать API без контроллеров
* Маршруты описываются прямо в `Program.cs`

**Отличия от контроллеров:**

* Меньше кода
* Нет строгой структуры MVC
* Подходит для микросервисов и небольших API

**Преимущества Minimal API:**

* Простота и скорость разработки
* Легковесность
* Высокая производительность

**Ограничения:**

* Меньше встроенных инструментов для фильтров и валидации
* Подходит для небольших и средних проектов

---

### 5. Примеры Minimal API

**Простейший пример:**

```csharp
var builder = WebApplication.CreateBuilder(args);
var app = builder.Build();

app.MapGet("/products", (IProductService service) => service.GetAll());
app.MapGet("/products/{id}", (int id, IProductService service) => 
{
    var product = service.GetById(id);
    return product is not null ? Results.Ok(product) : Results.NotFound();
});

app.MapPost("/products", (Product product, IProductService service) =>
{
    service.Add(product);
    return Results.Created($"/products/{product.Id}", product);
});

app.Run();
```

**Особенности:**

* Используем `MapGet`, `MapPost`, `MapPut`, `MapDelete` для маршрутов
* DI работает напрямую через параметры метода

---

### 6. Сравнение контроллеров и Minimal API

| Особенность     | Контроллеры        | Minimal API                |
| --------------- | ------------------ | -------------------------- |
| Структура       | MVC                | Прямо в Program.cs         |
| Количество кода | Больше             | Меньше                     |
| Валидация       | Атрибуты, фильтры  | Через код                  |
| Подходит для    | Сложных приложений | Микросервисов, простых API |
| Расширяемость   | Высокая            | Ограниченная               |

**Когда использовать:**

* Контроллеры — большие проекты, сложная архитектура, MVC
* Minimal API — быстрые сервисы, микросервисы, маленькие REST API

---

### 7. Обработка ошибок и валидация

**Валидация входных данных:**

```csharp
public class Product
{
    [Required]
    public string Name { get; set; }

    [Range(0.01, 1000)]
    public decimal Price { get; set; }
}
```

**Обработка ошибок в контроллерах:**

```csharp
if (!ModelState.IsValid) return BadRequest(ModelState);
```

**В Minimal API:**

```csharp
app.MapPost("/products", (Product product) =>
{
    if (string.IsNullOrEmpty(product.Name)) return Results.BadRequest("Name is required");
    return Results.Ok(product);
});
```

**Middleware для глобальной обработки ошибок:**

```csharp
app.UseExceptionHandler("/error");
```

---

### 8. Резюме

* **Контроллеры** — классический способ создания API, хорошо структурирован, поддерживает MVC
* **Minimal API** — современный легковесный подход, код минимален, быстрее разрабатывается
* DI работает в обоих подходах одинаково
* Валидация и обработка ошибок могут быть реализованы как на уровне контроллера, так и на уровне Minimal API

---

### 9. Контрольные вопросы

1. Чем контроллеры отличаются от Minimal API?
2. Какие HTTP-методы чаще всего используются в Web API?
3. Как внедрять сервисы в Minimal API?
4. Когда лучше использовать контроллеры, а когда Minimal API?
5. Как реализовать валидацию данных в контроллере и Minimal API?
6. Какие преимущества Minimal API перед контроллерами?
7. Как обрабатывать ошибки глобально в ASP.NET Core?

---

Если хочешь, я могу подготовить **ещё расширенную версию лекции на 5000 слов**, где подробно разобраны реальные сценарии построения API, продвинутые техники маршрутизации, обработка ошибок, Swagger интеграция и сравнение производительности контроллеров и Minimal API, чтобы лекция была максимально учебной и практичной.

Хочешь, чтобы я сделал такую расширенную версию?
