# Лекция 21. Маршрутизация в ASP.NET Core

Маршрутизация в ASP.NET Core: принципы, конфигурация и примеры использования в веб-приложениях и API

---

## План лекции

1. **Введение в маршрутизацию**

   * Что такое маршрутизация
   * Роль маршрутизации в веб-приложениях и API
   * HTTP-запрос и путь к ресурсу

2. **Концепция маршрутизации в ASP.NET Core**

   * Endpoint Routing
   * Middleware маршрутизации
   * Основные компоненты: Route, Endpoint, RouteData

3. **Конвенциональная маршрутизация (Conventional Routing)**

   * Определение маршрутов в Startup/Program
   * Параметры маршрута и шаблоны
   * Примеры маршрутов для контроллеров

4. **Атрибутная маршрутизация (Attribute Routing)**

   * Определение маршрутов через атрибуты
   * Маршруты на уровне контроллера и действия
   * Примеры сложных маршрутов с параметрами

5. **Маршрутизация в Minimal API**

   * MapGet, MapPost и другие методы
   * Использование параметров и шаблонов маршрута
   * Примеры реализации REST API

6. **Обработка параметров и ограничений**

   * Типы параметров
   * Ограничения маршрутов
   * Значения по умолчанию и необязательные параметры

7. **Приоритеты и совпадение маршрутов**

   * Правила сопоставления маршрутов
   * Конфликты маршрутов
   * Маршруты по умолчанию

8. **Резюме и выводы**

9. **Контрольные вопросы**

---

## Подробное содержание лекции

### 1. Введение в маршрутизацию

Маршрутизация — это процесс сопоставления **HTTP-запроса с обработчиком** (контроллером, действием или функцией).

**Зачем нужна маршрутизация:**

* Определяет, какой код будет выполняться для конкретного URL
* Позволяет создавать чистые и читаемые адреса
* Поддерживает REST API и динамические веб-страницы

**Пример запроса и маршрута:**

```
GET /products/5
```

* `GET` — HTTP-метод
* `/products/5` — путь, который нужно сопоставить с действием контроллера

---

### 2. Концепция маршрутизации в ASP.NET Core

ASP.NET Core использует **Endpoint Routing**:

* **Middleware маршрутизации** (`app.UseRouting()`) определяет маршруты
* **Endpoint Middleware** (`app.UseEndpoints()`) сопоставляет запрос с конечной точкой
* **RouteData** — содержит информацию о параметрах маршрута

**Пример базовой конфигурации маршрутизации в Program.cs:**

```csharp
var builder = WebApplication.CreateBuilder(args);
var app = builder.Build();

app.UseRouting();

app.UseEndpoints(endpoints =>
{
    endpoints.MapControllerRoute(
        name: "default",
        pattern: "{controller=Home}/{action=Index}/{id?}");
});

app.Run();
```

---

### 3. Конвенциональная маршрутизация (Conventional Routing)

Конвенциональная маршрутизация задаёт шаблон маршрутов для всей группы контроллеров.

**Пример шаблона:**

```csharp
pattern: "{controller=Home}/{action=Index}/{id?}"
```

* `controller=Home` — значение по умолчанию
* `action=Index` — значение по умолчанию
* `id?` — необязательный параметр

**Пример запроса:**

```
GET /Products/Details/3
```

* Контроллер: ProductsController
* Действие: Details
* Параметр: id = 3

**Преимущество:**

* Простая настройка для большинства приложений
  **Недостаток:**
* Менее гибкая, чем атрибутная маршрутизация

---

### 4. Атрибутная маршрутизация (Attribute Routing)

Атрибутная маршрутизация задаётся **на уровне контроллера и действия**.

**Пример простого контроллера с атрибутной маршрутизацией:**

```csharp
[Route("api/products")]
public class ProductsController : ControllerBase
{
    [HttpGet]
    public IActionResult GetAll() => Ok("All products");

    [HttpGet("{id}")]
    public IActionResult GetById(int id) => Ok($"Product {id}");
}
```

**Преимущество:**

* Возможность создавать сложные и индивидуальные маршруты для действий
* Удобно для REST API

**Примеры сложных маршрутов:**

```csharp
[HttpGet("category/{categoryId}/products/{productId}")]
public IActionResult GetByCategory(int categoryId, int productId) => Ok();
```

---

### 5. Маршрутизация в Minimal API

Minimal API использует методы `MapGet`, `MapPost`, `MapPut`, `MapDelete`.

**Пример:**

```csharp
var builder = WebApplication.CreateBuilder(args);
var app = builder.Build();

app.MapGet("/products", () => new[] { "Book", "Pen" });
app.MapGet("/products/{id:int}", (int id) => $"Product {id}");
app.MapPost("/products", (Product product) => Results.Created($"/products/{product.Id}", product));

app.Run();
```

Особенности:

* Параметры маршрута автоматически сопоставляются с аргументами метода
* DI можно использовать через параметры метода

---

### 6. Обработка параметров и ограничений

**Типы параметров маршрута:**

* `int`, `string`, `Guid` и т.д.

**Ограничения маршрута:**

```csharp
[HttpGet("{id:int}")]   // только целые числа
[HttpGet("{slug:alpha}")] // только буквы
```

**Необязательные параметры:**

```csharp
[HttpGet("{id?}")]
public IActionResult Get(int? id) { ... }
```

**Значения по умолчанию:**

```csharp
[HttpGet("{page=1}")]
public IActionResult GetPage(int page) { ... }
```

---

### 7. Приоритеты и совпадение маршрутов

* Маршруты проверяются **по порядку их добавления**
* Более конкретные маршруты имеют **высший приоритет**
* Конфликты маршрутов приводят к ошибкам сопоставления

**Пример конфликта:**

```csharp
[HttpGet("{id}")]
[HttpGet("special")]
public IActionResult Get(string id) { ... }
```

Решение: менять порядок или использовать уникальные шаблоны

**Маршруты по умолчанию:**

* Используются для страниц Home/Index и других часто вызываемых маршрутов

---

### 8. Резюме

* Маршрутизация сопоставляет HTTP-запросы с обработчиками
* ASP.NET Core использует Endpoint Routing и Middleware
* Конвенциональная маршрутизация задаёт шаблон для всей группы контроллеров
* Атрибутная маршрутизация задаётся на уровне контроллера и действий
* Minimal API использует MapGet/MapPost и позволяет быстро создавать маршруты
* Параметры, ограничения и значения по умолчанию помогают контролировать корректность запросов
* Приоритет маршрутов важен для предотвращения конфликтов

---

### 9. Контрольные вопросы

1. Что такое маршрутизация и зачем она нужна в ASP.NET Core?
2. Чем отличается конвенциональная маршрутизация от атрибутной?
3. Как задаются маршруты в Minimal API?
4. Какие типы параметров можно использовать в маршрутах?
5. Что такое необязательные параметры и значения по умолчанию?
6. Как определить приоритет маршрутов и избежать конфликтов?
7. Как маршрутизация интегрируется с Dependency Injection?