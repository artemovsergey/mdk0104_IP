# Лекция 22. Аутентификация и авторизация в ASP.NET Core

## Тема лекции

**Аутентификация и авторизация в ASP.NET Core: принципы, механизмы и примеры реализации безопасных приложений.**

---

## План лекции

1. **Введение в безопасность веб-приложений**

   * Разница между аутентификацией и авторизацией
   * Важность безопасности в современных приложениях
   * Угрозы безопасности без контроля доступа

2. **Аутентификация в ASP.NET Core**

   * Определение и цели
   * Типы аутентификации
   * Cookie Authentication
   * JWT (JSON Web Token)

3. **Настройка аутентификации**

   * Конфигурация в Program.cs
   * Использование Identity Framework
   * Пример настройки JWT аутентификации

4. **Авторизация в ASP.NET Core**

   * Определение и цели
   * Роли и политики
   * Claims-based авторизация
   * Примеры использования атрибутов `[Authorize]`

5. **Identity Framework**

   * Что такое ASP.NET Core Identity
   * Пользователи, роли и claims
   * Настройка регистрации и входа
   * Примеры реализации CRUD для пользователей

6. **JWT и токен-базированная авторизация**

   * Структура JWT
   * Генерация и проверка токенов
   * Использование JWT в API

7. **Аутентификация и авторизация в контроллерах и Minimal API**

   * Пример использования атрибутов `[Authorize]`
   * Ограничение доступа к маршрутам Minimal API

8. **Резюме и выводы**

9. **Контрольные вопросы**

---

## Подробное содержание лекции

### 1. Введение в безопасность веб-приложений

**Аутентификация** — процесс проверки личности пользователя.
**Авторизация** — процесс проверки прав пользователя на выполнение действий или доступ к ресурсам.

**Пример:**

* Аутентификация: пользователь вводит логин и пароль.
* Авторизация: пользователь с ролью «Admin» может редактировать данные, обычный пользователь — только просматривать.

**Опасности при отсутствии контроля доступа:**

* Незаконный доступ к данным
* Модификация или удаление информации
* Утечка конфиденциальной информации

---

### 2. Аутентификация в ASP.NET Core

**Типы аутентификации:**

* Cookie Authentication — хранение состояния пользователя через cookie
* JWT (JSON Web Token) — токен на стороне клиента для API
* OAuth/OpenID Connect — сторонние провайдеры (Google, Facebook)

**Cookie Authentication**

* Используется в веб-приложениях с MVC и Razor Pages
* Данные о пользователе хранятся на сервере и/или клиенте

**JWT Authentication**

* Подходит для REST API и микросервисов
* Токен содержит claims и подпись для проверки подлинности

---

### 3. Настройка аутентификации

**Пример настройки Identity и Cookie Authentication:**

```csharp
builder.Services.AddIdentity<ApplicationUser, IdentityRole>()
    .AddEntityFrameworkStores<ApplicationDbContext>()
    .AddDefaultTokenProviders();

builder.Services.ConfigureApplicationCookie(options =>
{
    options.LoginPath = "/Account/Login";
    options.AccessDeniedPath = "/Account/AccessDenied";
});
```

**Пример настройки JWT:**

```csharp
builder.Services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme)
    .AddJwtBearer(options =>
    {
        options.TokenValidationParameters = new TokenValidationParameters
        {
            ValidateIssuer = true,
            ValidateAudience = true,
            ValidateLifetime = true,
            ValidIssuer = "MyApp",
            ValidAudience = "MyApp",
            IssuerSigningKey = new SymmetricSecurityKey(
                Encoding.UTF8.GetBytes("supersecretkey123"))
        };
    });
```

---

### 4. Авторизация в ASP.NET Core

**Роли и политики**

* Роли: определяют права группы пользователей (`Admin`, `User`)
* Политики: более гибкий способ определения правил доступа через claims

**Пример использования атрибутов:**

```csharp
[Authorize(Roles = "Admin")]
public IActionResult AdminDashboard() => View();

[Authorize(Policy = "Over18")]
public IActionResult AdultContent() => View();
```

**Claims-based авторизация:**

* Claims — утверждения о пользователе (`Age`, `SubscriptionLevel`)
* Политики проверяют claims для предоставления доступа

**Пример политики:**

```csharp
services.AddAuthorization(options =>
{
    options.AddPolicy("Over18", policy =>
        policy.RequireClaim("Age", "18"));
});
```

---

### 5. Identity Framework

ASP.NET Core Identity — встроенная система управления пользователями, ролями и аутентификацией.

**Основные компоненты:**

* Users — пользователи приложения
* Roles — роли пользователей
* Claims — дополнительные утверждения о пользователе
* Tokens — токены для подтверждения e-mail или смены пароля

**Пример регистрации пользователя:**

```csharp
var user = new ApplicationUser { UserName = model.Email, Email = model.Email };
var result = await _userManager.CreateAsync(user, model.Password);
if (result.Succeeded)
{
    await _signInManager.SignInAsync(user, isPersistent: false);
}
```

**Пример проверки роли:**

```csharp
if (await _userManager.IsInRoleAsync(user, "Admin")) { ... }
```

---

### 6. JWT и токен-базированная авторизация

**Структура JWT:**

1. Header — алгоритм и тип токена
2. Payload — claims пользователя
3. Signature — цифровая подпись

**Пример генерации JWT:**

```csharp
var claims = new[]
{
    new Claim(JwtRegisteredClaimNames.Sub, user.UserName),
    new Claim(ClaimTypes.Role, "Admin")
};

var key = new SymmetricSecurityKey(Encoding.UTF8.GetBytes("supersecretkey123"));
var creds = new SigningCredentials(key, SecurityAlgorithms.HmacSha256);

var token = new JwtSecurityToken(
    issuer: "MyApp",
    audience: "MyApp",
    claims: claims,
    expires: DateTime.Now.AddHours(1),
    signingCredentials: creds
);

return new JwtSecurityTokenHandler().WriteToken(token);
```

**Использование JWT в API:**

* Клиент отправляет токен в заголовке Authorization
* Сервер проверяет токен и предоставляет доступ

---

### 7. Аутентификация и авторизация в контроллерах и Minimal API

**В контроллерах:**

```csharp
[Authorize]
[ApiController]
[Route("api/[controller]")]
public class ProductsController : ControllerBase
{
    [HttpGet]
    public IActionResult GetAll() => Ok("All products");
}
```

**В Minimal API:**

```csharp
app.MapGet("/products", [Authorize] (IProductService service) =>
{
    return service.GetAll();
});
```

* DI работает вместе с аутентификацией и авторизацией
* Можно ограничивать доступ к конкретным маршрутам

---

### 8. Резюме

* Аутентификация подтверждает личность пользователя, авторизация — права доступа
* ASP.NET Core поддерживает Cookie, JWT и Identity Framework
* Роли и политики позволяют гибко управлять доступом
* Minimal API и контроллеры интегрируются с авторизацией через `[Authorize]`
* JWT широко используется для REST API и микросервисов

---

### 9. Контрольные вопросы

1. В чем разница между аутентификацией и авторизацией?
2. Какие типы аутентификации поддерживает ASP.NET Core?
3. Как настроить JWT аутентификацию?
4. Что такое claims и как они используются в авторизации?
5. Как применять роли и политики для ограничения доступа?
6. Какие возможности предоставляет ASP.NET Core Identity?
7. Как интегрировать аутентификацию в Minimal API?