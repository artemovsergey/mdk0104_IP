# Практическая работа 29. Работа с JWT токенами, ролями и разрешениями

Реализация аутентификации и авторизации в ASP.NET Core с использованием JWT, ролей и разрешений

---

## Цель работы

* Познакомиться с принципами работы JWT (JSON Web Token).
* Научиться реализовывать аутентификацию с помощью JWT в ASP.NET Core.
* Освоить работу с ролями и разрешениями для разграничения доступа.
* На практике реализовать API с безопасным доступом к ресурсам.

---

## Теоретическая часть

### 1. Что такое JWT

JWT (JSON Web Token) — это компактный безопасный способ передачи информации между клиентом и сервером в виде JSON-объекта.

**Структура JWT:**

1. **Header** — содержит информацию о типе токена и алгоритме подписи.
2. **Payload** — полезная нагрузка (claims), например, userId, role.
3. **Signature** — цифровая подпись для проверки целостности токена.

**Пример payload:**

```json
{
  "sub": "1234567890",
  "name": "John Doe",
  "role": "Admin",
  "exp": 1710614400
}
```

### 2. Роли и разрешения

* **Роли** — группы пользователей с одинаковыми правами (`Admin`, `User`, `Manager`).
* **Разрешения (Policies)** — более детальные правила доступа (`CanEditProducts`, `CanDeleteOrders`).

### 3. Принцип работы аутентификации JWT в ASP.NET Core

1. Пользователь вводит логин/пароль.
2. Сервер проверяет учетные данные и создает JWT с нужными claims.
3. Клиент хранит токен и передает его в заголовке `Authorization: Bearer <token>` при запросах к API.
4. Сервер проверяет подпись токена и claims для разрешения доступа.

---

## Ход работы

1. Создать новый проект ASP.NET Core Web API.
2. Добавить модель пользователя и роли.
3. Настроить сервис генерации JWT токенов.
4. Создать контроллер для регистрации и логина пользователей.
5. Настроить политики авторизации и роли.
6. Реализовать защищенные эндпоинты с проверкой JWT и ролей.
7. Проверить работу с помощью Postman или Swagger.
8. Сделать скриншоты работы приложения.
9. Создать репозиторий:

   * Проект приложения
   * Папка `images` с скриншотами
   * `README.md` с примером кода и подсветкой синтаксиса

---

## Практический пример

**Модель пользователя: User.cs**

```csharp
public class User
{
    public string Username { get; set; }
    public string Password { get; set; } // Для учебного примера хранение в чистом виде
    public string Role { get; set; }
}
```

**Сервис генерации JWT: JwtService.cs**

```csharp
using System.IdentityModel.Tokens.Jwt;
using System.Security.Claims;
using Microsoft.IdentityModel.Tokens;
using System.Text;

public class JwtService
{
    private readonly string _secret;
    public JwtService(string secret) => _secret = secret;

    public string GenerateToken(User user)
    {
        var claims = new[]
        {
            new Claim(ClaimTypes.Name, user.Username),
            new Claim(ClaimTypes.Role, user.Role)
        };

        var key = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(_secret));
        var creds = new SigningCredentials(key, SecurityAlgorithms.HmacSha256);

        var token = new JwtSecurityToken(
            issuer: "MyApp",
            audience: "MyApp",
            claims: claims,
            expires: DateTime.Now.AddHours(1),
            signingCredentials: creds
        );

        return new JwtSecurityTokenHandler().WriteToken(token);
    }
}
```

**Контроллер AuthController.cs**

```csharp
[ApiController]
[Route("api/[controller]")]
public class AuthController : ControllerBase
{
    private readonly JwtService _jwtService;
    private static List<User> users = new List<User>();

    public AuthController(JwtService jwtService) => _jwtService = jwtService;

    [HttpPost("register")]
    public IActionResult Register(User user)
    {
        users.Add(user);
        return Ok("User registered");
    }

    [HttpPost("login")]
    public IActionResult Login(User login)
    {
        var user = users.FirstOrDefault(u => u.Username == login.Username && u.Password == login.Password);
        if (user == null) return Unauthorized();

        var token = _jwtService.GenerateToken(user);
        return Ok(new { token });
    }
}
```

**Защищенный контроллер ProductsController.cs**

```csharp
[ApiController]
[Route("api/[controller]")]
[Authorize(Roles = "Admin")]
public class ProductsController : ControllerBase
{
    [HttpGet]
    public IActionResult Get() => Ok(new[] { "Product1", "Product2" });
}
```

---

## Варианты заданий (выбирается по номеру в журнале)

1. Реализовать регистрацию и логин пользователей с JWT, роль `Admin`.
2. Создать защищенный эндпоинт `/products`, доступный только для `Admin`.
3. Добавить роль `User` и ограничить доступ к `/orders` только для `User` и `Admin`.
4. Реализовать JWT с временем жизни 30 минут и проверкой истечения.
5. Добавить кастомные claims (`CanEdit`, `CanDelete`) и проверку в политике.
6. Создать Swagger документацию с поддержкой JWT авторизации.
7. Реализовать middleware для логирования всех успешных аутентификаций.
8. Создать тестовый клиент на Blazor или Razor Page для отправки JWT и проверки доступа.
9. Реализовать регистрацию с проверкой уникальности имени пользователя.
10. Создать эндпоинт `GET /profile`, доступный для любого авторизованного пользователя.
11. Настроить refresh token для продления JWT.
12. Реализовать хранение пользователей в памяти и поддержку удаления пользователей.
13. Создать эндпоинт с разрешением только для пользователей с claim `CanEdit=true`.
14. Настроить обработку ошибок авторизации с возвратом соответствующих кодов HTTP.
15. Реализовать логирование всех попыток доступа к защищенным эндпоинтам.

---

## Критерии оценки

| Балл | Критерий                                                                                               |
| ---- | ------------------------------------------------------------------------------------------------------ |
| 2    | Реализована регистрация и логин, но JWT и роли работают частично                                       |
| 3    | JWT успешно генерируется и используется для доступа к защищенным эндпоинтам                            |
| 4    | Полностью рабочая аутентификация и авторизация с ролями, проверка claims, защита эндпоинтов            |
| 5    | Полностью функциональное приложение с JWT, ролями, разрешениями, Swagger, README с кодом и скриншотами |

---

## Контрольные вопросы

1. Что такое JWT и из каких частей он состоит?
2. Как реализуется аутентификация с помощью JWT в ASP.NET Core?
3. Что такое роли и claims в контексте авторизации?
4. Как ограничить доступ к эндпоинту по роли?
5. Как проверить срок действия JWT?
6. Как использовать JWT в Swagger или Postman для тестирования?
7. Какие шаги нужно выполнить для создания защищенного API с JWT и ролями?

---

## Структура репозитория

```
ПрактическаяРабота_29/
 ├── JwtAuthApp/            # проект ASP.NET Core Web API
 ├── images/                # скриншоты работы программы
 │    ├── 1.png
 │    └── 2.png
 └── README.md
```

**Пример README.md:**

````markdown
# Практическая работа №29: Работа с JWT токенами, ролями и разрешениями

## Вариант Y

### Задание
Реализовать регистрацию и логин пользователей с JWT. Создать защищенный эндпоинт `/products`, доступный только для роли `Admin`.

### Пример кода

```csharp
// Сервис генерации JWT
public string GenerateToken(User user)
{
    var claims = new[]
    {
        new Claim(ClaimTypes.Name, user.Username),
        new Claim(ClaimTypes.Role, user.Role)
    };
    ...
}
````

```csharp
// Контроллер для логина
[HttpPost("login")]
public IActionResult Login(User login)
{
    ...
}
```

```csharp
// Защищенный контроллер
[Authorize(Roles = "Admin")]
public class ProductsController : ControllerBase
{
    [HttpGet]
    public IActionResult Get() => Ok(new[] { "Product1", "Product2" });
}
```

### Скриншоты

![JWT авторизация](images/1.png)

```
