# Практическая работа 30. Фоновые задачи. Hangfire

Реализация фоновых задач в ASP.NET Core с использованием Hangfire

---

## Цель работы

* Познакомиться с концепцией фоновых задач и очередей задач.
* Научиться использовать Hangfire для запуска периодических и отложенных заданий.
* Освоить мониторинг выполнения фоновых задач через встроенный Dashboard Hangfire.
* На практике реализовать простые фоновые задачи, такие как отправка уведомлений или обновление данных.

---

## Теоретическая часть

### 1. Что такое фоновые задачи

Фоновые задачи — это операции, выполняемые асинхронно, независимо от основного потока приложения.

**Примеры:**

* Отправка email уведомлений.
* Очистка временных данных.
* Генерация отчетов.
* Синхронизация данных с внешними сервисами.

### 2. Hangfire

Hangfire — библиотека для .NET, позволяющая выполнять фоновые задачи с надежной очередью и мониторингом.

**Особенности Hangfire:**

* Простая интеграция с ASP.NET Core.
* Поддержка одноразовых, отложенных и периодических задач.
* Встроенный Dashboard для мониторинга выполнения.
* Поддержка различных хранилищ данных (SQL Server, Redis, PostgreSQL).

### 3. Типы задач Hangfire

* **Fire-and-forget:** выполняется один раз сразу после добавления.
* **Delayed (отложенные):** выполняется через заданный интервал времени.
* **Recurring (повторяющиеся):** выполняются по расписанию (CRON).
* **Continuation (цепочка):** задача выполняется после другой задачи.

---

## Ход работы

1. Создать новый проект ASP.NET Core Web API или MVC.
2. Добавить пакет Hangfire через NuGet:

```bash
dotnet add package Hangfire
dotnet add package Hangfire.AspNetCore
```

3. Настроить Hangfire в `Program.cs`:

   * Подключение хранилища (например, SQL Server или InMemory).
   * Добавление Dashboard для мониторинга.
4. Создать сервис для фоновых задач, например `EmailService` или `ReportService`.
5. Реализовать методы для разных типов задач: Fire-and-forget, Delayed, Recurring.
6. В контроллере создать эндпоинты для добавления задач.
7. Проверить работу задач через Dashboard Hangfire.
8. Сделать скриншоты работы приложения и Dashboard.
9. Создать репозиторий:

   * Проект приложения
   * Папка `images` с скриншотами
   * `README.md` с примером кода и подсветкой синтаксиса

---

## Практический пример

**Пример конфигурации Hangfire в Program.cs:**

```csharp
using Hangfire;
using Hangfire.MemoryStorage;

var builder = WebApplication.CreateBuilder(args);

// Hangfire configuration
builder.Services.AddHangfire(config =>
    config.SetDataCompatibilityLevel(CompatibilityLevel.Version_170)
          .UseSimpleAssemblyNameTypeSerializer()
          .UseRecommendedSerializerSettings()
          .UseMemoryStorage()
);
builder.Services.AddHangfireServer();

builder.Services.AddControllers();
var app = builder.Build();

// Hangfire Dashboard
app.UseHangfireDashboard("/hangfire");

app.MapControllers();
app.Run();
```

**Сервис для фоновых задач: EmailService.cs**

```csharp
public class EmailService
{
    public void SendEmail(string to, string subject)
    {
        Console.WriteLine($"Email sent to {to} with subject {subject}");
    }
}
```

**Контроллер: TasksController.cs**

```csharp
using Hangfire;
using Microsoft.AspNetCore.Mvc;

[ApiController]
[Route("api/[controller]")]
public class TasksController : ControllerBase
{
    private readonly EmailService _emailService;

    public TasksController(EmailService emailService) => _emailService = emailService;

    [HttpPost("fire-and-forget")]
    public IActionResult FireAndForget()
    {
        BackgroundJob.Enqueue(() => _emailService.SendEmail("user@example.com", "Test Fire-and-Forget"));
        return Ok("Task queued");
    }

    [HttpPost("delayed")]
    public IActionResult Delayed()
    {
        BackgroundJob.Schedule(() => _emailService.SendEmail("user@example.com", "Delayed Task"), TimeSpan.FromMinutes(1));
        return Ok("Delayed task scheduled");
    }

    [HttpPost("recurring")]
    public IActionResult Recurring()
    {
        RecurringJob.AddOrUpdate("daily-email", () => _emailService.SendEmail("user@example.com", "Daily Email"), Cron.Daily);
        return Ok("Recurring task scheduled");
    }
}
```

---

## Варианты заданий (выбирается по номеру в журнале)

1. Реализовать Fire-and-forget задачу для отправки email.
2. Реализовать Delayed задачу для отправки email через 5 минут.
3. Создать Recurring задачу, выполняющуюся ежедневно в 9:00.
4. Создать цепочку задач: Fire-and-forget → Delayed.
5. Настроить задачи на генерацию ежедневного отчета.
6. Создать задачу очистки временных данных каждый час.
7. Реализовать задачу для синхронизации данных с внешним API каждые 10 минут.
8. Настроить Dashboard Hangfire и показать активные задачи.
9. Реализовать Fire-and-forget задачу с логированием результата в файл.
10. Создать Recurring задачу для уведомления пользователей о событии раз в неделю.
11. Реализовать задачу для обновления статистики пользователей каждый день.
12. Настроить отложенную задачу с передачей параметров.
13. Создать цепочку задач для обработки заказов: верификация → отправка уведомления → обновление статуса.
14. Реализовать задачу очистки неактивных пользователей раз в день.
15. Настроить Recurring задачу с CRON выражением для работы в определенные дни недели.

---

## Критерии оценки

| Балл | Критерий                                                                                         |
| ---- | ------------------------------------------------------------------------------------------------ |
| 2    | Hangfire установлен, задачи выполняются частично, Dashboard не настроен                          |
| 3    | Fire-and-forget или Delayed задачи работают корректно, Dashboard настроен                        |
| 4    | Все типы задач (Fire-and-forget, Delayed, Recurring) реализованы, Dashboard доступен             |
| 5    | Полностью функциональные фоновые задачи, цепочки задач, мониторинг, README с кодом и скриншотами |

---

## Контрольные вопросы

1. Что такое фоновые задачи и зачем они нужны?
2. Какие типы задач поддерживает Hangfire?
3. Как настроить Hangfire в ASP.NET Core?
4. Как создать Fire-and-forget, Delayed и Recurring задачи?
5. Как использовать Dashboard Hangfire для мониторинга задач?
6. Как передавать параметры в задачи Hangfire?
7. Какие сценарии применения фоновых задач в веб-приложениях вы знаете?

---

## Структура репозитория

```
ПрактическаяРабота_30/
 ├── HangfireApp/            # проект ASP.NET Core
 ├── images/                 # скриншоты работы приложения и Dashboard
 │    ├── 1.png
 │    └── 2.png
 └── README.md
```

**Пример README.md:**

````markdown
# Практическая работа №30: Фоновые задачи. Hangfire

## Вариант Y

### Задание
Реализовать Fire-and-forget, Delayed и Recurring задачи с Hangfire. Настроить Dashboard для мониторинга.

### Пример кода

```csharp
// Fire-and-forget задача
BackgroundJob.Enqueue(() => emailService.SendEmail("user@example.com", "Fire-and-Forget"));

// Delayed задача
BackgroundJob.Schedule(() => emailService.SendEmail("user@example.com", "Delayed Task"), TimeSpan.FromMinutes(1));

// Recurring задача
RecurringJob.AddOrUpdate("daily-email", () => emailService.SendEmail("user@example.com", "Daily Email"), Cron.Daily);
````

### Скриншоты

![Dashboard Hangfire](images/1.png)

```