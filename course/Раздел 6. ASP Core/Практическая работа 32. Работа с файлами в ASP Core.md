# Практическая работа 32. Работа с файлами в ASP.NET Core

Реализация загрузки, сохранения и обработки файлов в ASP.NET Core

---

## Цель работы

* Познакомиться с механизмами работы с файлами в ASP.NET Core.
* Научиться реализовывать загрузку файлов через формы и API.
* Освоить сохранение файлов на сервере, чтение и удаление.
* На практике реализовать базовые операции работы с файлами и проверку их формата и размера.

---

## Теоретическая часть

### 1. Основы работы с файлами

Веб-приложения часто обрабатывают файлы, загружаемые пользователями, такие как изображения, документы, CSV или PDF.

**Основные операции:**

* **Загрузка файла** через форму (`<input type="file">`) или API.
* **Сохранение файла** на сервере с указанием пути.
* **Чтение содержимого файла** для обработки данных.
* **Удаление файла** при необходимости.

### 2. Классы ASP.NET Core для работы с файлами

* `IFormFile` — представляет загружаемый файл.
* `IFormFileCollection` — коллекция загружаемых файлов.
* `FileStream` — для чтения и записи файлов.
* `Path` — для работы с путями файлов.

### 3. Безопасность работы с файлами

* Ограничение типа файлов (`ContentType` или расширение).
* Ограничение размера файла.
* Генерация уникальных имен для сохранения на сервере.
* Сохранение файлов в отдельную папку внутри приложения.

---

## Ход работы

1. Создать новый проект ASP.NET Core (MVC или API).
2. Настроить форму загрузки файла на странице или API эндпоинт для приема файлов.
3. Создать папку `Uploads` для хранения файлов на сервере.
4. Реализовать проверку типа и размера файла.
5. Сохранить файл с уникальным именем.
6. Реализовать чтение списка загруженных файлов и возможность их удаления.
7. Сделать скриншоты работы приложения.
8. Создать репозиторий:

   * Проект приложения
   * Папка `images` с скриншотами
   * `README.md` с примером кода и подсветкой синтаксиса

---

## Практический пример

**Форма загрузки файла: Upload.cshtml**

```html
@page
@model UploadModel
<h2>Загрузка файла</h2>

<form method="post" enctype="multipart/form-data">
    <input type="file" asp-for="File" />
    <button type="submit">Загрузить</button>
</form>

@if (Model.Message != null)
{
    <p>@Model.Message</p>
}
```

**PageModel: Upload.cshtml.cs**

```csharp
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;

public class UploadModel : PageModel
{
    [BindProperty]
    public IFormFile File { get; set; }

    public string Message { get; set; }

    public async Task<IActionResult> OnPostAsync()
    {
        if (File != null && File.Length > 0)
        {
            var filePath = Path.Combine(Directory.GetCurrentDirectory(), "Uploads", Path.GetRandomFileName() + Path.GetExtension(File.FileName));

            using (var stream = new FileStream(filePath, FileMode.Create))
            {
                await File.CopyToAsync(stream);
            }

            Message = "Файл успешно загружен!";
        }
        else
        {
            Message = "Выберите файл для загрузки!";
        }

        return Page();
    }
}
```

**API контроллер для загрузки файлов: FilesController.cs**

```csharp
[ApiController]
[Route("api/[controller]")]
public class FilesController : ControllerBase
{
    [HttpPost("upload")]
    public async Task<IActionResult> Upload(IFormFile file)
    {
        if (file == null || file.Length == 0)
            return BadRequest("Файл не выбран");

        var filePath = Path.Combine(Directory.GetCurrentDirectory(), "Uploads", Path.GetRandomFileName() + Path.GetExtension(file.FileName));

        using (var stream = new FileStream(filePath, FileMode.Create))
        {
            await file.CopyToAsync(stream);
        }

        return Ok("Файл успешно загружен");
    }
}
```

---

## Варианты заданий (выбирается по номеру в журнале)

1. Реализовать загрузку одного файла через форму Razor Page.
2. Реализовать загрузку нескольких файлов через форму.
3. Ограничить загрузку только изображений (`.jpg`, `.png`).
4. Ограничить размер файла (например, до 2 МБ).
5. Сохранение файлов с уникальными именами для предотвращения перезаписи.
6. Создать API для загрузки файлов и возврата списка всех файлов.
7. Реализовать удаление загруженных файлов через кнопку или API.
8. Сделать отображение списка файлов на веб-странице с возможностью скачивания.
9. Проверка типа файла по MIME (`ContentType`).
10. Сохранение загруженных файлов в подпапки по дате загрузки.
11. Реализовать валидацию названия файла (только латиница и цифры).
12. Загрузка текстового файла и чтение содержимого на сервере.
13. Реализовать фоновые задачи для обработки загруженных файлов (например, с Hangfire).
14. Логирование всех операций с файлами (загрузка, удаление).
15. Создать уведомление пользователю после успешной загрузки через Toast или alert.

---

## Критерии оценки

| Балл | Критерий                                                                                                           |
| ---- | ------------------------------------------------------------------------------------------------------------------ |
| 2    | Загрузка файла реализована частично, ошибки обработки возможны                                                     |
| 3    | Файл успешно загружается и сохраняется, базовая проверка типа и размера                                            |
| 4    | Загрузка нескольких файлов, уникальные имена, обработка ошибок, отображение списка файлов                          |
| 5    | Полностью функциональное приложение с загрузкой, удалением, проверкой типа и размера, README с кодом и скриншотами |

---

## Контрольные вопросы

1. Какие классы ASP.NET Core используются для работы с файлами?
2. Как реализовать загрузку файлов через Razor Pages и API?
3. Как ограничить размер и тип загружаемых файлов?
4. Как сохранять файлы с уникальными именами?
5. Как отобразить список загруженных файлов на веб-странице?
6. Как реализовать удаление файлов с сервера?
7. Какие меры безопасности следует применять при работе с файлами?

---

## Структура репозитория

```
ПрактическаяРабота_32/
 ├── FileUploadApp/           # проект ASP.NET Core
 ├── Uploads/                 # папка для загруженных файлов
 ├── images/                  # скриншоты работы приложения
 │    ├── 1.png
 │    └── 2.png
 └── README.md
```

**Пример README.md:**

````markdown
# Практическая работа №32: Работа с файлами в ASP.NET Core

## Вариант Y

### Задание
Реализовать загрузку файлов через форму Razor Page. Проверка типа и размера файла. Сохранение с уникальным именем.

### Пример кода

```csharp
[BindProperty]
public IFormFile File { get; set; }

public async Task<IActionResult> OnPostAsync()
{
    if (File != null && File.Length > 0)
    {
        var filePath = Path.Combine(Directory.GetCurrentDirectory(), "Uploads", Path.GetRandomFileName() + Path.GetExtension(File.FileName));

        using (var stream = new FileStream(filePath, FileMode.Create))
        {
            await File.CopyToAsync(stream);
        }

        Message = "Файл успешно загружен!";
    }
    else
    {
        Message = "Выберите файл для загрузки!";
    }

    return Page();
}
````

### Скриншоты

![Загрузка файла](images/1.png)

```
