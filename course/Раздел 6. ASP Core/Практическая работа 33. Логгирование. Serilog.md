# Практическая работа 33. Логгирование. Serilog

Реализация логгирования в ASP.NET Core с использованием Serilog

## Цель работы

* Ознакомиться с концепцией логгирования и его ролью в разработке веб-приложений.
* Научиться использовать Serilog для записи логов в разные источники (файл, консоль, базу данных).
* Реализовать запись логов различных уровней (`Information`, `Warning`, `Error`).
* Освоить конфигурирование Serilog через код и файл конфигурации.

---

## Теоретическая часть

### 1. Что такое логгирование

Логгирование — процесс регистрации информации о работе приложения, который помогает:

* Отслеживать ошибки и исключения.
* Анализировать поведение пользователей.
* Проводить аудит действий.
* Диагностировать проблемы в продуктивной среде.

**Уровни логов:**

* `Verbose` — детальная информация для отладки.
* `Debug` — информация для отладки разработчика.
* `Information` — важные события работы приложения.
* `Warning` — потенциальные проблемы.
* `Error` — ошибки, требующие внимания.
* `Fatal` — критические ошибки, приводящие к сбою приложения.

### 2. Serilog

Serilog — это гибкая библиотека логгирования для .NET с поддержкой структурированных логов.

**Особенности Serilog:**

* Поддержка записи логов в различные sinks (файлы, базы данных, консоль, Seq, ElasticSearch).
* Возможность структурированных логов (`{PropertyName}`) для последующего анализа.
* Легкая интеграция с ASP.NET Core.
* Настройка уровней логирования и фильтров.

---

## Ход работы

1. Создать новый проект ASP.NET Core (MVC, Razor Pages или API).
2. Установить Serilog и необходимые пакеты через NuGet:

```bash
dotnet add package Serilog.AspNetCore
dotnet add package Serilog.Sinks.Console
dotnet add package Serilog.Sinks.File
```

3. Настроить Serilog в `Program.cs` или `Startup.cs`:

```csharp
using Serilog;

var builder = WebApplication.CreateBuilder(args);

Log.Logger = new LoggerConfiguration()
    .WriteTo.Console()
    .WriteTo.File("Logs/log-.txt", rollingInterval: RollingInterval.Day)
    .MinimumLevel.Information()
    .CreateLogger();

builder.Host.UseSerilog();

builder.Services.AddControllersWithViews();
var app = builder.Build();

app.UseSerilogRequestLogging();

app.MapControllers();
app.Run();
```

4. Использовать Serilog для записи логов в контроллерах и сервисах:

```csharp
using Microsoft.AspNetCore.Mvc;
using Serilog;

[ApiController]
[Route("api/[controller]")]
public class SampleController : ControllerBase
{
    [HttpGet("test")]
    public IActionResult Test()
    {
        Log.Information("Тестовый запрос выполнен в {Time}", DateTime.Now);
        try
        {
            throw new Exception("Тестовое исключение");
        }
        catch (Exception ex)
        {
            Log.Error(ex, "Произошла ошибка");
        }
        return Ok("Проверка логов выполнена");
    }
}
```

5. Проверить создание логов в консоли и в файле.
6. Сделать скриншоты работы приложения с логами.
7. Создать репозиторий:

   * Проект приложения
   * Папка `images` с скриншотами
   * `README.md` с примером кода и подсветкой синтаксиса

---

## Практический пример

**Пример записи логов в контроллере:**

```csharp
Log.Information("Пользователь {User} вошел в систему", "admin");
Log.Warning("Попытка доступа к запрещенному ресурсу");
Log.Error(new InvalidOperationException("Ошибка операции"), "Произошла ошибка при выполнении задачи");
```

**Конфигурация Serilog через appsettings.json:**

```json
{
  "Serilog": {
    "MinimumLevel": "Information",
    "WriteTo": [
      { "Name": "Console" },
      { "Name": "File", "Args": { "path": "Logs/log-.txt", "rollingInterval": "Day" } }
    ]
  }
}
```

---

## Варианты заданий (выбирается по номеру в журнале)

1. Настроить Serilog для записи логов в консоль.
2. Настроить Serilog для записи логов в файл с ежедневной ротацией.
3. Реализовать запись логов разных уровней (`Information`, `Warning`, `Error`).
4. Добавить логирование запросов и ответов в API контроллере.
5. Логирование действий пользователей (например, вход в систему).
6. Логирование ошибок с исключениями.
7. Логирование выполнения фоновых задач (Hangfire).
8. Настроить структуру логов с именованными свойствами (`User`, `Action`).
9. Реализовать фильтр логирования для определенных маршрутов или уровней.
10. Логирование в нескольких sinks одновременно (файл + консоль).
11. Настроить логирование в JSON формате.
12. Реализовать запись логов в базу данных (например, SQLite или SQL Server).
13. Логирование долгих запросов (время выполнения > 1 секунда).
14. Настроить логирование исключений с подробным стек-трейсом.
15. Создать страницу Dashboard для отображения последних логов (например, с чтением из файла).

---

## Критерии оценки

| Балл | Критерий                                                                                                                     |
| ---- | ---------------------------------------------------------------------------------------------------------------------------- |
| 2    | Serilog подключен, запись логов работает частично                                                                            |
| 3    | Логи записываются корректно в консоль или файл, минимальные уровни работают                                                  |
| 4    | Логи разных уровней, обработка исключений, запись в несколько sinks, интеграция с контроллерами                              |
| 5    | Полностью функциональное логирование с уровнями, структурированными логами, Dashboard или JSON, README с кодом и скриншотами |

---

## Контрольные вопросы

1. Что такое Serilog и зачем он используется?
2. Какие уровни логирования существуют?
3. Как настроить Serilog в ASP.NET Core через код и через appsettings.json?
4. Как записывать структурированные логи с параметрами?
5. Как логировать исключения и ошибки в приложении?
6. Какие sinks поддерживает Serilog?
7. Как интегрировать логирование с контроллерами и сервисами?

---

## Структура репозитория

```
ПрактическаяРабота_33/
 ├── SerilogApp/            # проект ASP.NET Core
 ├── images/                # скриншоты работы приложения с логами
 │    ├── 1.png
 │    └── 2.png
 └── README.md
```

**Пример README.md:**

````markdown
# Практическая работа №33: Логгирование. Serilog

## Вариант Y

### Задание
Настроить Serilog для записи логов в консоль и файл. Реализовать логирование действий пользователей и ошибок.

### Пример кода

```csharp
// Program.cs
Log.Logger = new LoggerConfiguration()
    .WriteTo.Console()
    .WriteTo.File("Logs/log-.txt", rollingInterval: RollingInterval.Day)
    .MinimumLevel.Information()
    .CreateLogger();

builder.Host.UseSerilog();
````

```csharp
// Контроллер
Log.Information("Пользователь {User} вошел в систему", "admin");
Log.Warning("Попытка доступа к запрещенному ресурсу");
Log.Error(new InvalidOperationException("Ошибка операции"), "Произошла ошибка");
```

### Скриншоты

![Логи в консоли и файле](images/1.png)

```

